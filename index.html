<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello Milk Tee - Smart Log</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        .font-brand { font-family: 'Outfit', sans-serif; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Milk Tea Aesthetic */
        .bg-milk-base { background-color: #faf9f6; }
        .bg-milk-card { background-color: #ffffff; }
        .text-milk-dark { color: #5d4037; }
        .text-milk-brand { color: #d97706; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e8dcd1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d6c0b0; }

        /* Markdown Styling */
        .prose h1, .prose h2 { font-weight: 800; margin-top: 1.5em; margin-bottom: 0.5em; color: #5d4037; font-family: 'Outfit', sans-serif; }
        .prose h3 { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; color: #d97706; }
        .prose ul { list-style: disc; padding-left: 1.5em; }
        .prose li { margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; }
        .prose strong { color: #5d4037; }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-milk-base text-stone-700 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.Firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, collection, addDoc, deleteDoc, doc, updateDoc, onSnapshot, serverTimestamp, writeBatch
        };
        window.dispatchEvent(new Event('firebase-loaded'));
    </script>

    <!-- App Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icons ---
        const Icons = {
            Coffee: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            Send: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Brain: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Sparkles: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/><path d="M3 5h4"/></svg>,
            Settings: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>,
            Download: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Upload: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            CheckCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Trash2: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Link: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            X: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Layers: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12.83 21.41-.66 1.15a.5.5 0 0 1-.84 0l-.66-1.15"/><path d="m16.5 17.5 5.5-10.5L12 2 2.5 7.5l5.5 10.5"/><path d="M2.5 7.5 12 13l9.5-5.5"/><path d="M12 2v11"/></svg>
        };

        // --- AI Helpers ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // Feature 1: Grammar Correction AND Translation to Chinese
        async function cleanTextAI(apiKey, text) {
            const prompt = `
                You are an assistant for a fashion store staff member who handles Design, Operations, and Admin tasks. 
                The user has provided a "brain dump" log which might be messy (mixed English, Pinyin, slang). 
                1. Fix grammar and spelling.
                2. Make it concise and clear.
                3. Keep the original meaning and tone (first person).
                4. Crucially, translate the final cleaned text into natural, professional Chinese.
                Output ONLY the cleaned and translated Chinese text string. No quotes.
                
                Input: "${text}"
            `;
            
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        }

        // Feature 2: Task Extraction (Tasks in Chinese) - HYBRID ROLE FOCUS
        async function analyzeTasksAI(apiKey, logText) {
            const prompt = `
                You are an assistant to a Hybrid Designer & Operations Staff at a fashion store (Hello Milk Tee). 
                Your goal is to extract ALL actionable tasks found in the log, regardless of whether they are Design, Admin, Finance, Logistics, or Insurance related. 
                Do NOT ignore admin tasks. The user is responsible for them.
                
                Based on the log (which is in Chinese): "${logText}", extract actionable tasks. If the log mentions finishing something, do NOT create a task, but return an empty array.
                
                The task structure must be:
                [ { "title": "<Task Title in Chinese>", "desc": "<Short Description in Chinese>", "time": <Estimated Minutes (Number)>, "category": "admin|design|marketing|finance|ops" } ]
                
                Ensure 'time' is a number and 'category' is one of the strings above.
                Output ONLY the raw JSON array.
            `;
            
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();

            if (data.error) throw new Error(data.error.message);
            
            try {
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonStr = rawText.replace(/```json\n|```/g, '').trim();
                return JSON.parse(jsonStr);
            } catch (e) {
                console.error("Failed to parse AI task JSON. Response was:", data.candidates[0].content.parts[0].text, e);
                return []; 
            }
        }
        
        // Feature 3: Task Decomposition (HYBRID ROLE AWARE)
        async function decomposeTaskAI(apiKey, task) {
             const prompt = `
                You are a project manager helping a Hybrid Designer & Operations Staff. 
                Decompose the following task into 3-5 actionable sub-steps.
                
                Task: "${task.title}"
                Description: "${task.desc}"
                Category: ${task.category}
                
                If the task is DESIGN related: Focus on visual impact, brand consistency, and file prep.
                If the task is ADMIN/FINANCE/OPS related: Focus on accuracy, efficiency, data checking, and compliance.
                
                Output the result in Markdown format.
                Structure MUST use these headings in Chinese:
                ## 任务分解：[Task Title]
                ### 执行步骤 (Action Steps)
                * **第1步: [Step Title] (约 X 分钟)**
                    * **执行:** [Action]
                    * **注意:** [Key Focus/Risk]
                * ... (Repeat for 3-5 steps)
                ### 核心焦点 (Core Focus)
                [1-2 sentences summarizing the key goal. If Admin: focus on accuracy. If Design: focus on aesthetics.]
            `;

            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        }


        // Feature 4: Weekly Insight and Focus (HYBRID ROLE AWARE)
        async function generateInsightAI(apiKey, logs) {
            const recentLogs = logs.map(l => {
                const date = new Date(l.createdAt?.seconds * 1000).toLocaleString('zh-CN', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                return `[${date}] ${l.text}`;
            }).slice(0, 30).join('\n'); // Take up to 30 recent logs

            const prompt = `
                You are a professional Executive Coach advising a Hybrid Designer & Operations Staff. Analyze the following recent work log stream.
                
                The user handles BOTH Design (Shopify, Visuals) AND Operations (Insurance, Finance, Admin). Do not criticize them for doing admin work; instead, help them manage the context switching.
                
                1. Summarize the major themes worked on (Mixed Design & Ops). Use Chinese.
                2. Identify potential efficiency bottlenecks (e.g., context switching costs, lack of templates for admin). Use Chinese.
                3. Provide 3 specific, high-impact focus recommendations for the next week, balancing both Design progress and Operational maintenance. Use Chinese.
                
                Format your response in Markdown, using Chinese headings (e.g., ### 总结).
                
                Recent Log Stream:
                ---
                ${recentLogs}
                ---
            `;
            
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        }

        // --- Task Detail Modal Component ---
        const TaskDetailModal = ({ task, onClose, apiKey }) => {
            const [decomposition, setDecomposition] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const loadDecomposition = async () => {
                    if (!apiKey) {
                        setError("错误: 缺少 API Key，无法生成任务分解。");
                        setIsLoading(false);
                        return;
                    }
                    setIsLoading(true);
                    setError(null);
                    try {
                        const result = await decomposeTaskAI(apiKey, task);
                        setDecomposition(result);
                    } catch (e) {
                        setError("生成任务分解时出错: " + e.message);
                        console.error("Decomposition failed:", e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadDecomposition();
            }, [task.id, apiKey]);

            if (!task) return null;

            return (
                <div className="modal-backdrop fade-in" onClick={onClose}>
                    <div 
                        className="bg-milk-card rounded-2xl p-6 md:p-8 w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl transform transition-all"
                        onClick={e => e.stopPropagation()} // Prevent closing when clicking inside
                    >
                        <div className="flex justify-between items-center border-b pb-3 mb-4 sticky top-0 bg-milk-card z-10">
                            <h2 className="font-brand text-2xl font-bold text-milk-brand flex items-center gap-2">
                                <Icons.Layers className="w-6 h-6"/> 任务分解
                            </h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-stone-100 text-stone-500">
                                <Icons.X className="w-5 h-5"/>
                            </button>
                        </div>
                        
                        <div className="bg-orange-50 p-4 rounded-xl mb-4 border border-orange-200">
                             <p className="text-sm text-stone-700"><strong>原始任务:</strong> {task.title} ({task.time}m)</p>
                             <p className="text-xs text-stone-500 mt-1">{task.desc}</p>
                             <span className="text-[10px] uppercase font-bold text-orange-600 bg-orange-100 px-2 py-0.5 rounded mt-2 inline-block">{task.category}</span>
                        </div>

                        {isLoading && (
                            <div className="text-center py-12 text-stone-400">
                                <div className="animate-spin inline-block mr-2"><Icons.Sparkles className="w-5 h-5"/></div>
                                正在为您的混合角色生成执行计划...
                            </div>
                        )}
                        
                        {error && (
                            <div className="text-center py-12 text-red-500 bg-red-50 p-4 rounded-xl border border-red-200">
                                <p className="font-bold">加载错误:</p>
                                <p className="text-sm">{error}</p>
                            </div>
                        )}

                        {decomposition && (
                            <div className="prose max-w-none text-stone-700 leading-relaxed">
                                <div dangerouslySetInnerHTML={{ __html: marked.parse(decomposition) }} />
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        // --- Main App ---
        function App() {
            const [config, setConfig] = useState(null);
            const [appId, setAppId] = useState('milktee-smartlog');
            const [user, setUser] = useState(null);
            
            // Data
            const [logs, setLogs] = useState([]);
            const [tasks, setTasks] = useState([]);
            
            // Input State
            const [inputText, setInputText] = useState('');
            const [aiKey, setAiKey] = useState(localStorage.getItem('milktea_ai_key') || '');
            const [isProcessing, setIsProcessing] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [showInsight, setShowInsight] = useState(false); 
            const [insightResult, setInsightResult] = useState('');
            const [selectedTask, setSelectedTask] = useState(null); // NEW STATE for decomposition
            
            const fbRef = useRef({});
            const fileInputRef = useRef(null);
            const scrollRef = useRef(null);

            // 1. Init Firebase
            useEffect(() => {
                if (typeof __firebase_config !== 'undefined') {
                    const cfg = JSON.parse(__firebase_config);
                    const id = typeof __app_id !== 'undefined' ? __app_id : 'default';
                    initFirebase(cfg, id);
                } else {
                    const saved = localStorage.getItem('milktea_fb_config');
                    if(saved) initFirebase(JSON.parse(saved), 'local');
                }
            }, []);

            const initFirebase = (cfg, id) => {
                try {
                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, onSnapshot, doc, deleteDoc, addDoc, updateDoc, serverTimestamp, writeBatch } = window.Firebase;
                    try { initializeApp(cfg); } catch(e) {}
                    fbRef.current = { auth: getAuth(), db: getFirestore(), collection, onSnapshot, doc, deleteDoc, addDoc, updateDoc, serverTimestamp, writeBatch };
                    setConfig(cfg); setAppId(id);

                    const initAuth = async () => {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(fbRef.current.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(fbRef.current.auth);
                        }
                    };
                    initAuth();

                    onAuthStateChanged(fbRef.current.auth, u => setUser(u));
                } catch(e) { console.error(e); }
            };

            // 2. Listeners (Logs & Tasks)
            useEffect(() => {
                if (!user) return;
                const { db, collection, onSnapshot } = fbRef.current;
                
                // Listen to Logs (History)
                const logUnsub = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), snap => {
                    // DEDUPLICATION LOGIC: Use a Map to ensure unique IDs
                    const uniqueMap = new Map();
                    snap.docs.forEach(doc => {
                        uniqueMap.set(doc.id, { id: doc.id, ...doc.data() });
                    });
                    const d = Array.from(uniqueMap.values());
                    d.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setLogs(d);
                });

                // Listen to Derived Tasks
                const taskUnsub = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'tasks'), snap => {
                    // DEDUPLICATION LOGIC: Use a Map to ensure unique IDs
                    const uniqueMap = new Map();
                    snap.docs.forEach(doc => {
                        uniqueMap.set(doc.id, { id: doc.id, ...doc.data() });
                    });
                    const d = Array.from(uniqueMap.values());
                    d.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setTasks(d);
                });

                return () => { logUnsub(); taskUnsub(); };
            }, [user, appId]);

            // --- Core Logic ---
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputText.trim() || !user) return;
                // Do not use alert()
                if (!aiKey) { setShowSettings(true); setStatusMsg("错误: 请先设置您的 API Key！"); return; }
                
                setShowInsight(false);

                const rawText = inputText;
                setInputText('');
                setIsProcessing(true);
                setStatusMsg('步骤 1: 正在清理、翻译并修正语法...');

                try {
                    const { db, collection, addDoc, serverTimestamp } = fbRef.current;
                    
                    // 1. AI Clean and Translate Text
                    let cleanedText = rawText;
                    try {
                        cleanedText = await cleanTextAI(aiKey, rawText);
                    } catch (err) {
                        console.warn("Cleaning and translation failed, using raw text", err);
                        setStatusMsg('语法修正和翻译失败，将使用原始文本记录。');
                    }

                    // 2. Save Log
                    setStatusMsg('步骤 2: 正在保存到记忆流...');
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'), {
                        raw: rawText,
                        text: cleanedText,
                        createdAt: serverTimestamp(),
                        type: 'log'
                    });

                    // 3. AI Analyze for Tasks (Task generation is now instructed to focus on designer tasks)
                    setStatusMsg('步骤 3: 正在分析并提取任务 (混合角色)...');
                    const newTasks = await analyzeTasksAI(aiKey, cleanedText);
                    
                    if (newTasks && newTasks.length > 0) {
                         newTasks.forEach(async t => {
                             await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'tasks'), {
                                 ...t,
                                 createdAt: serverTimestamp(),
                                 done: false,
                                 sourceLog: cleanedText
                             });
                         });
                         setStatusMsg(`已添加 ${newTasks.length} 个新任务 (中文)!`);
                    } else {
                        setStatusMsg('日志已记录。未检测到新任务。');
                    }

                    setTimeout(() => { setIsProcessing(false); setStatusMsg(''); }, 2000);

                } catch (e) {
                    setStatusMsg("错误: " + e.message);
                    console.error("提交日志失败:", e);
                    setIsProcessing(false);
                    setInputText(rawText); // restore text
                }
            };
            
            const handleGenerateInsight = async () => {
                if (!aiKey) { setShowSettings(true); setStatusMsg("错误: 请先设置您的 API Key！"); return; }
                if (logs.length === 0) { setStatusMsg("错误: 请先记录一些活动！"); return; }

                setShowInsight(true); // Switch view
                setInsightResult(''); // Clear previous result
                setIsProcessing(true);
                setStatusMsg('正在生成每周洞察与焦点分析 (混合角色)...');

                try {
                    const result = await generateInsightAI(aiKey, logs); 
                    setInsightResult(result);
                    setStatusMsg('洞察报告已生成!');
                } catch (e) {
                    setInsightResult('生成洞察时出错: ' + e.message);
                } finally {
                    setIsProcessing(false);
                    setTimeout(() => setStatusMsg(''), 2000);
                }
            };

            const handleExport = () => {
                const bundle = { logs, tasks, exportedAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(bundle)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `milktee_full_backup.json`; a.click();
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        const { db, collection, doc, writeBatch, serverTimestamp } = fbRef.current;
                        const batch = writeBatch(db);
                        
                        if(data.logs) data.logs.forEach(l => {
                            const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'logs'));
                            batch.set(ref, { ...l, createdAt: serverTimestamp(), imported: true });
                        });
                        if(data.tasks) data.tasks.forEach(t => {
                            const ref = doc(collection(db, 'artifacts', appId, 'users', user.uid, 'tasks'));
                            batch.set(ref, { ...t, createdAt: serverTimestamp(), imported: true });
                        });
                        await batch.commit();
                        setStatusMsg("Memory Injected Successfully!");
                        setTimeout(() => setStatusMsg(''), 2000);
                    } catch(err) { setStatusMsg("Import failed"); }
                };
                reader.readAsText(file);
            };

            const toggleTask = async (id, currentStat) => {
                const { db, doc, updateDoc } = fbRef.current;
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', id), { done: !currentStat });
            };

            const deleteTask = async (id) => {
                if(window.prompt("确认删除此任务？请输入 'YES'") !== 'YES') return;
                const { db, doc, deleteDoc } = fbRef.current;
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', id));
            };

            const formatDate = (seconds) => {
                if (!seconds) return '刚刚';
                const date = new Date(seconds * 1000);
                return new Intl.DateTimeFormat('zh-CN', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: 'numeric' 
                }).format(date);
            };

            // Config Screen
            if (!config && typeof __firebase_config === 'undefined') {
                return (
                    <div className="flex h-screen items-center justify-center bg-milk-base p-4">
                         <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
                             <h2 className="font-brand font-bold text-2xl text-milk-dark mb-4">设置要求</h2>
                             <textarea className="w-full h-32 border p-2 rounded mb-4 text-xs" placeholder='Firebase JSON' onBlur={e=>localStorage.setItem('milktea_fb_config', e.target.value)}></textarea>
                             <button onClick={()=>window.location.reload()} className="bg-stone-800 text-white px-6 py-2 rounded-full">保存并重新加载</button>
                         </div>
                    </div>
                );
            }

            return (
                <div className="flex h-full max-w-6xl mx-auto w-full bg-white shadow-2xl overflow-hidden md:rounded-2xl md:my-4 md:border border-stone-100">
                    <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" />

                    {/* Task Detail Modal */}
                    {selectedTask && (
                        <TaskDetailModal 
                            task={selectedTask} 
                            onClose={() => setSelectedTask(null)} 
                            apiKey={aiKey}
                        />
                    )}

                    {/* Left Panel: Log Stream (The Memory) */}
                    <div className="w-full md:w-5/12 bg-stone-50 border-r border-stone-100 flex flex-col">
                        <header className="p-4 border-b border-stone-200 bg-white flex justify-between items-center">
                            <h1 className="font-brand font-bold text-xl text-milk-dark flex items-center gap-2">
                                <Icons.Brain className="w-6 h-6 text-purple-600" /> 日志流 (Log Stream)
                            </h1>
                            <div className="flex gap-2">
                                <button onClick={handleExport} className="text-stone-400 hover:text-stone-600" title="导出数据"><Icons.Download className="w-5 h-5"/></button>
                                <button onClick={()=>fileInputRef.current.click()} className="text-stone-400 hover:text-stone-600" title="导入数据"><Icons.Upload className="w-5 h-5"/></button>
                                <button onClick={()=>setShowSettings(!showSettings)} className={`transition-colors ${!aiKey ? 'text-red-500 animate-pulse' : 'text-stone-400'}`} title="API Key 设置"><Icons.Settings className="w-5 h-5"/></button>
                            </div>
                        </header>
                        
                        {/* Settings Panel (Inline) */}
                        {showSettings && (
                            <div className="p-4 bg-stone-800 text-white">
                                <div className="flex justify-between items-center mb-2">
                                    <label className="text-xs uppercase font-bold tracking-wider block text-stone-400">Gemini API Key</label>
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-amber-400 hover:text-amber-300 flex items-center gap-1 font-bold">
                                        <Icons.Link className="w-3 h-3" /> 获取免费 Key
                                    </a>
                                </div>
                                <div className="flex gap-2">
                                    <input type="password" value={aiKey} onChange={e=>setAiKey(e.target.value)} className="flex-1 bg-stone-700 rounded px-3 py-2 text-sm outline-none border border-stone-600 focus:border-amber-500" placeholder="AIzaSy..." />
                                    <button onClick={()=>{localStorage.setItem('milktea_ai_key', aiKey); setShowSettings(false);}} className="bg-amber-600 px-4 rounded text-sm font-bold hover:bg-amber-500">保存</button>
                                </div>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto p-4 space-y-6" ref={scrollRef}>
                            {logs.length === 0 && (
                                <div className="text-center py-10 text-stone-400">
                                    <p className="text-sm">暂无日志。请在下方输入您的想法！</p>
                                </div>
                            )}
                            {logs.map((log) => (
                                <div key={log.id} className="relative pl-4 border-l-2 border-stone-200 fade-in">
                                    <div className="absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-stone-300"></div>
                                    <div className="text-[10px] font-mono text-stone-400 uppercase tracking-wider mb-1">
                                        {formatDate(log.createdAt?.seconds)}
                                    </div>
                                    <div className="text-stone-800 text-sm leading-relaxed whitespace-pre-wrap">
                                        {log.text}
                                    </div>
                                    {log.raw !== log.text && (
                                        <div className="mt-1 text-[10px] text-purple-400 flex items-center gap-1">
                                            <Icons.Sparkles className="w-3 h-3" /> 语法修正/翻译
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        {/* Input Area */}
                        <div className="p-4 bg-white border-t border-stone-200 z-10">
                            {isProcessing && (
                                <div className="mb-2 text-xs font-bold text-amber-600 animate-pulse flex items-center gap-2">
                                    <span className="w-2 h-2 bg-amber-600 rounded-full"></span>
                                    {statusMsg}
                                </div>
                            )}
                            <form onSubmit={handleSubmit} className="relative">
                                <textarea 
                                    value={inputText}
                                    onChange={e=>setInputText(e.target.value)}
                                    className="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 pr-12 text-sm outline-none focus:ring-2 focus:ring-amber-500 focus:bg-white transition-all resize-none"
                                    rows="3"
                                    placeholder="输入凌乱的想法，让 AI 帮你整理和提取任务..."
                                    disabled={isProcessing}
                                    onKeyDown={e => { if(e.key === 'Enter' && !e.shiftKey) handleSubmit(e); }}
                                ></textarea>
                                <button 
                                    type="submit" 
                                    disabled={!inputText.trim() || isProcessing}
                                    className="absolute right-2 bottom-2 p-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed transition-transform active:scale-95"
                                    title="分析并添加到日志"
                                >
                                    <Icons.Send className="w-4 h-4" />
                                </button>
                            </form>
                        </div>
                    </div>

                    {/* Right Panel: Smart Dashboard (The Tasks / Insight) */}
                    <div className="hidden md:flex w-7/12 bg-white flex-col">
                        <header className="p-4 border-b border-stone-100 flex justify-between items-center">
                            <h2 className="font-brand font-bold text-xl text-milk-brand flex items-center gap-2">
                                <Icons.Coffee className="w-6 h-6" /> {showInsight ? '每周焦点分析' : '待办任务'}
                            </h2>
                            {!showInsight && (
                                <div className="flex gap-2 items-center">
                                    <button 
                                        onClick={handleGenerateInsight} 
                                        disabled={isProcessing || logs.length === 0}
                                        className="text-xs font-bold bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded-full transition-colors flex items-center gap-1 disabled:opacity-50"
                                        title="分析日志并生成每周焦点报告"
                                    >
                                        <Icons.Sparkles className="w-4 h-4"/> Weekly Focus
                                    </button>
                                    <div className="text-xs font-bold bg-amber-50 text-amber-700 px-3 py-1 rounded-full">
                                        {tasks.filter(t => !t.done).length} 待处理
                                    </div>
                                </div>
                            )}
                            {showInsight && (
                                <button 
                                    onClick={() => setShowInsight(false)} 
                                    className="text-sm font-bold bg-stone-100 hover:bg-stone-200 text-stone-700 px-3 py-1 rounded-full transition-colors"
                                >
                                    返回任务
                                </button>
                            )}
                        </header>

                        <div className="flex-1 overflow-y-auto p-6 bg-dots">
                            {/* Insight View */}
                            {showInsight && (
                                <div className="fade-in bg-white p-6 rounded-2xl shadow-xl border border-purple-200">
                                    <h3 className="text-purple-600 font-extrabold text-2xl mb-4 flex items-center gap-2 font-brand">
                                        <Icons.Sparkles className="w-6 h-6"/> AI 洞察报告 (混合角色)
                                    </h3>
                                    {insightResult ? (
                                        // Render markdown content from LLM
                                        <div 
                                            className="prose max-w-none text-stone-700 leading-loose"
                                            dangerouslySetInnerHTML={{ __html: marked.parse(insightResult) }} 
                                        />
                                    ) : (
                                        <div className="text-center py-12 text-stone-400">
                                            <div className="animate-spin inline-block mr-2"><Icons.Sparkles className="w-5 h-5"/></div>
                                            {statusMsg || "正在加载分析..."}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Task List View */}
                            {!showInsight && (
                                <div className="grid grid-cols-1 gap-3">
                                    {tasks.length === 0 ? (
                                        <div className="border-2 border-dashed border-stone-100 rounded-2xl p-10 text-center">
                                            <p className="text-stone-400 font-brand text-lg">当前任务清空。</p>
                                            <p className="text-stone-300 text-sm mt-2">AI 会根据您的**混合角色日志**自动生成任务。</p>
                                        </div>
                                    ) : tasks.map(task => (
                                        <div 
                                            key={task.id} 
                                            className={`group bg-white border border-stone-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all flex items-start gap-3 fade-in cursor-pointer ${task.done ? 'opacity-60 bg-stone-50' : 'hover:border-amber-300'}`}
                                            onClick={() => setSelectedTask(task)} // Click to open decomposition
                                        >
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); toggleTask(task.id, task.done); }}
                                                className={`mt-1 w-5 h-5 rounded border flex items-center justify-center transition-colors ${task.done ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-stone-300 hover:border-emerald-400'}`}
                                            >
                                                {task.done && <Icons.CheckCircle className="w-3 h-3" />}
                                            </button>
                                            
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start">
                                                    <h3 className={`font-bold text-stone-800 ${task.done ? 'line-through text-stone-400' : ''}`}>{task.title}</h3>
                                                    <span className="text-[10px] font-mono text-stone-400 bg-stone-100 px-1.5 py-0.5 rounded">{task.time}m</span>
                                                </div>
                                                
                                                {task.desc && <p className="text-xs text-stone-500 mt-1">{task.desc}</p>}
                                                
                                                <div className="mt-3 flex justify-between items-center">
                                                    <span className={`text-[10px] font-bold uppercase px-2 py-0.5 rounded ${
                                                        task.category === 'design' ? 'bg-rose-50 text-rose-600' :
                                                        task.category === 'marketing' ? 'bg-orange-50 text-orange-600' :
                                                        task.category === 'admin' ? 'bg-slate-50 text-slate-600' :
                                                        task.category === 'finance' ? 'bg-green-50 text-green-600' :
                                                        'bg-blue-50 text-blue-600'
                                                    }`}>
                                                        {task.category || 'general'}
                                                    </span>
                                                    <div className="opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); deleteTask(task.id); }} 
                                                            className="text-stone-300 hover:text-red-400" 
                                                            title="删除任务"
                                                        >
                                                            <Icons.Trash2 className="w-4 h-4"/>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>