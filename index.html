<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello Milk Tee - Smart Log</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        .font-brand { font-family: 'Outfit', sans-serif; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Milk Tea Aesthetic */
        .bg-milk-base { background-color: #faf9f6; }
        .bg-milk-card { background-color: #ffffff; }
        .text-milk-dark { color: #5d4037; }
        .text-milk-brand { color: #d97706; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e8dcd1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d6c0b0; }

        /* Markdown Styling */
        .prose h1, .prose h2 { font-weight: 800; margin-top: 1.5em; margin-bottom: 0.5em; color: #5d4037; font-family: 'Outfit', sans-serif; }
        .prose h3 { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; color: #d97706; }
        .prose ul { list-style: disc; padding-left: 1.5em; }
        .prose li { margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; }
        .prose strong { color: #5d4037; }

        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        /* Background Dots Pattern for Right Panel */
        .bg-dots {
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-milk-base text-stone-700 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full"></div>

    <!-- App Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Icons (保留所有原版精美图标) ---
        const Icons = {
            Coffee: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            Send: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Brain: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Sparkles: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/><path d="M3 5h4"/></svg>,
            Settings: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>,
            Download: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Upload: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            CheckCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Trash2: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Link: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            X: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Layers: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12.83 21.41-.66 1.15a.5.5 0 0 1-.84 0l-.66-1.15"/><path d="m16.5 17.5 5.5-10.5L12 2 2.5 7.5l5.5 10.5"/><path d="M2.5 7.5 12 13l9.5-5.5"/><path d="M12 2v11"/></svg>,
            Save: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        };

        // --- AI Helpers ---
        // 使用 1.5-flash，这是目前最稳定、响应最快的免费版本
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent";
        
        // 1. 优化后的文本清理 Prompt：更自然的语气，更专业的中文
        async function cleanTextAI(apiKey, text) {
            const prompt = `
                You are a professional personal secretary for a fashion store manager.
                Rewrite the following raw log into a clear, first-person record in professional Chinese.
                
                Rules:
                1. Fix all grammar and spelling errors.
                2. If the input is English, translate it to natural, native-sounding Chinese.
                3. Keep the tone professional but personal (like a diary).
                4. Do NOT use quotes around the output.
                
                Input: "${text}"
            `;
            
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        }

        // 2. 优化后的任务提取 Prompt：更精准地生成任务卡片
        async function analyzeTasksAI(apiKey, logText) {
            const prompt = `
                Identify actionable tasks from this Chinese text: "${logText}".
                
                Return a JSON array of task objects. If no actionable tasks are found, return [].
                The JSON must strictly follow this format:
                [ 
                    { 
                        "title": "Short Task Title (Chinese)", 
                        "desc": "Brief description (Chinese)", 
                        "time": Number(estimated minutes, e.g. 30), 
                        "category": "design|admin|marketing|finance|ops" 
                    } 
                ]
                
                Output ONLY the raw JSON string. No Markdown code blocks.
            `;
            
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();

            if (data.error) throw new Error(data.error.message);
            
            try {
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonStr = rawText.replace(/```json\n|```/g, '').trim();
                return JSON.parse(jsonStr);
            } catch (e) {
                console.error("Task parsing failed", e);
                return []; 
            }
        }
        
        // 3. 任务分解
        async function decomposeTaskAI(apiKey, task) {
             const prompt = `
                作为项目经理，请将以下任务分解为 3-5 个具体的执行步骤。
                任务: "${task.title}" (${task.desc})
                
                请用中文 Markdown 格式输出。
                使用以下标题结构:
                ## 任务分解
                ### 执行步骤
                ### 核心注意点
            `;

            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        }

        // 4. 周报生成
        async function generateInsightAI(apiKey, logs) {
            const recentLogs = logs.slice(0, 30).map(l => l.text).join('\n');
            const prompt = `
                作为职业教练，请分析以下最近的工作日志，并生成一份简短的周报建议。
                日志内容:
                ${recentLogs}
                
                请用中文 Markdown 格式，包含: 1. 工作总结 2. 效率瓶颈 3. 下周重点。
            `;
            
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        }

        // --- Task Detail Modal (原版设计) ---
        const TaskDetailModal = ({ task, onClose, apiKey }) => {
            const [decomposition, setDecomposition] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const load = async () => {
                    try { setDecomposition(await decomposeTaskAI(apiKey, task)); } 
                    catch (e) { setDecomposition("无法生成: " + e.message); } 
                    finally { setIsLoading(false); }
                };
                load();
            }, [task]);

            return (
                <div className="modal-backdrop fade-in" onClick={onClose}>
                    <div className="bg-milk-card rounded-2xl p-6 md:p-8 w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center border-b pb-3 mb-4 sticky top-0 bg-milk-card z-10">
                            <h2 className="font-brand text-2xl font-bold text-milk-brand flex items-center gap-2">
                                <Icons.Layers className="w-6 h-6"/> 任务分解
                            </h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-stone-100 text-stone-500">
                                <Icons.X className="w-5 h-5"/>
                            </button>
                        </div>
                        <div className="bg-orange-50 p-4 rounded-xl mb-4 border border-orange-200">
                             <p className="text-sm text-stone-700"><strong>任务:</strong> {task.title}</p>
                             <p className="text-xs text-stone-500 mt-1">{task.desc}</p>
                        </div>
                        {isLoading ? (
                            <div className="text-center py-12 text-stone-400">
                                <div className="animate-spin inline-block mr-2"><Icons.Sparkles className="w-5 h-5"/></div>
                                AI 正在规划执行步骤...
                            </div>
                        ) : (
                            <div className="prose max-w-none text-stone-700 leading-relaxed text-sm" dangerouslySetInnerHTML={{ __html: marked.parse(decomposition || '') }} />
                        )}
                    </div>
                </div>
            );
        };


        // --- Main App ---
        function App() {
            // ---------------------------------------------------------
            // ⚠️ 1. 请把你的 Key 粘贴到下面的引号里！
            // ---------------------------------------------------------
            const HARDCODED_KEY = "AIzaSyBwNmtX2VZZybQBoQorPqH75LvQID5B9H0"; 

            // ⚠️ 2. 强制使用这个 Key
            const aiKey = HARDCODED_KEY; 

            // State
            const [logs, setLogs] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [showInsight, setShowInsight] = useState(false); 
            const [insightResult, setInsightResult] = useState('');
            const [selectedTask, setSelectedTask] = useState(null);
            
            const fileInputRef = useRef(null);
            const scrollRef = useRef(null);

            // Load Data from LocalStorage
            useEffect(() => {
                const savedData = localStorage.getItem('milktea_data_final');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        setLogs(parsed.logs || []);
                        setTasks(parsed.tasks || []);
                    } catch (e) { console.error(e); }
                }
            }, []);

            // Save Data to LocalStorage
            useEffect(() => {
                const data = { logs, tasks };
                localStorage.setItem('milktea_data_final', JSON.stringify(data));
            }, [logs, tasks]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputText.trim()) return;
                if (!aiKey || aiKey.includes("请在这里")) { alert("请在代码中填入 API Key"); return; }
                
                setShowInsight(false);
                const rawText = inputText;
                setInputText('');
                setIsProcessing(true);
                setStatusMsg('正在整理思路...');

                try {
                    // 1. Clean Text
                    let cleanedText = rawText;
                    try { cleanedText = await cleanTextAI(aiKey, rawText); } 
                    catch (err) { console.warn(err); }

                    const newLog = {
                        id: Date.now().toString(),
                        raw: rawText,
                        text: cleanedText,
                        createdAt: new Date().toISOString()
                    };
                    
                    setLogs(prev => [newLog, ...prev]);

                    // 2. Extract Tasks
                    setStatusMsg('正在提取待办...');
                    const newTasksRaw = await analyzeTasksAI(aiKey, cleanedText);
                    
                    if (newTasksRaw && newTasksRaw.length > 0) {
                         const newTasks = newTasksRaw.map((t, idx) => ({
                             ...t,
                             id: Date.now() + '-' + idx,
                             done: false
                         }));
                         setTasks(prev => [...newTasks, ...prev]);
                         setStatusMsg(`新增 ${newTasks.length} 个任务`);
                    } else {
                        setStatusMsg('已保存');
                    }

                } catch (e) {
                    setStatusMsg("出错: " + e.message);
                    setInputText(rawText);
                } finally {
                    setIsProcessing(false);
                    setTimeout(() => setStatusMsg(''), 2000);
                }
            };
            
            const handleGenerateInsight = async () => {
                if (!logs.length) return;
                setShowInsight(true);
                setInsightResult('');
                setIsProcessing(true);
                try {
                    const result = await generateInsightAI(aiKey, logs); 
                    setInsightResult(result);
                } catch (e) { setInsightResult(e.message); }
                setIsProcessing(false);
            };

            const toggleTask = (id) => setTasks(prev => prev.map(t => t.id === id ? { ...t, done: !t.done } : t));
            const deleteTask = (id) => { if(confirm("删除此任务?")) setTasks(prev => prev.filter(t => t.id !== id)); };
            
            const handleExport = () => {
                const blob = new Blob([JSON.stringify({logs, tasks})], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "milktea_backup.json"; a.click();
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        setLogs(data.logs || []); setTasks(data.tasks || []);
                        alert("数据已恢复");
                    } catch(err) { alert("文件格式错误"); }
                };
                reader.readAsText(file);
            };

            const formatDate = (isoString) => {
                if (!isoString) return '';
                return new Date(isoString).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' });
            };

            return (
                <div className="flex h-full max-w-6xl mx-auto w-full bg-white shadow-2xl overflow-hidden md:rounded-2xl md:my-4 md:border border-stone-100">
                    <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" />

                    {selectedTask && <TaskDetailModal task={selectedTask} onClose={() => setSelectedTask(null)} apiKey={aiKey} />}

                    {/* Left Panel: Log Stream */}
                    <div className="w-full md:w-5/12 bg-stone-50 border-r border-stone-100 flex flex-col">
                        <header className="p-4 border-b border-stone-200 bg-white flex justify-between items-center">
                            <h1 className="font-brand font-bold text-xl text-milk-dark flex items-center gap-2">
                                <Icons.Brain className="w-6 h-6 text-purple-600" /> 日志流
                            </h1>
                            <div className="flex gap-2">
                                <div className="text-[10px] text-stone-400 flex items-center gap-1 border border-stone-200 px-2 rounded-full">
                                    <Icons.Save className="w-3 h-3"/> 自动保存
                                </div>
                                <button onClick={handleExport} className="text-stone-400 hover:text-stone-600"><Icons.Download className="w-5 h-5"/></button>
                                <button onClick={()=>fileInputRef.current.click()} className="text-stone-400 hover:text-stone-600"><Icons.Upload className="w-5 h-5"/></button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 space-y-6" ref={scrollRef}>
                            {logs.length === 0 && (
                                <div className="text-center py-10 text-stone-400">
                                    <p className="text-sm">暂无日志。请在下方输入您的想法...</p>
                                </div>
                            )}
                            {logs.map((log) => (
                                <div key={log.id} className="relative pl-4 border-l-2 border-stone-200 fade-in">
                                    <div className="absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-stone-300"></div>
                                    <div className="text-[10px] font-mono text-stone-400 uppercase tracking-wider mb-1">
                                        {formatDate(log.createdAt)}
                                    </div>
                                    <div className="text-stone-800 text-sm leading-relaxed whitespace-pre-wrap">
                                        {log.text}
                                    </div>
                                    {log.raw !== log.text && (
                                        <div className="mt-1 text-[10px] text-purple-400 flex items-center gap-1">
                                            <Icons.Sparkles className="w-3 h-3" /> AI 润色
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        {/* Input Area */}
                        <div className="p-4 bg-white border-t border-stone-200 z-10">
                            {isProcessing && (
                                <div className="mb-2 text-xs font-bold text-amber-600 animate-pulse flex items-center gap-2">
                                    <span className="w-2 h-2 bg-amber-600 rounded-full"></span>
                                    {statusMsg}
                                </div>
                            )}
                            <form onSubmit={handleSubmit} className="relative">
                                <textarea 
                                    value={inputText}
                                    onChange={e=>setInputText(e.target.value)}
                                    className="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 pr-12 text-sm outline-none focus:ring-2 focus:ring-amber-500 focus:bg-white transition-all resize-none"
                                    rows="3"
                                    placeholder="输入想法..."
                                    disabled={isProcessing}
                                    onKeyDown={e => { if(e.key === 'Enter' && !e.shiftKey) handleSubmit(e); }}
                                ></textarea>
                                <button 
                                    type="submit" 
                                    disabled={!inputText.trim() || isProcessing}
                                    className="absolute right-2 bottom-2 p-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed transition-transform active:scale-95"
                                >
                                    <Icons.Send className="w-4 h-4" />
                                </button>
                            </form>
                        </div>
                    </div>

                    {/* Right Panel: Tasks */}
                    <div className="hidden md:flex w-7/12 bg-white flex-col">
                        <header className="p-4 border-b border-stone-100 flex justify-between items-center">
                            <h2 className="font-brand font-bold text-xl text-milk-brand flex items-center gap-2">
                                <Icons.Coffee className="w-6 h-6" /> {showInsight ? '每周焦点' : '待办任务'}
                            </h2>
                            {!showInsight && (
                                <div className="flex gap-2 items-center">
                                    <button 
                                        onClick={handleGenerateInsight} 
                                        disabled={isProcessing || logs.length === 0}
                                        className="text-xs font-bold bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded-full transition-colors flex items-center gap-1 disabled:opacity-50"
                                    >
                                        <Icons.Sparkles className="w-4 h-4"/> Weekly Focus
                                    </button>
                                    <div className="text-xs font-bold bg-amber-50 text-amber-700 px-3 py-1 rounded-full">
                                        {tasks.filter(t => !t.done).length} 待处理
                                    </div>
                                </div>
                            )}
                            {showInsight && (
                                <button 
                                    onClick={() => setShowInsight(false)} 
                                    className="text-sm font-bold bg-stone-100 hover:bg-stone-200 text-stone-700 px-3 py-1 rounded-full transition-colors"
                                >
                                    返回任务
                                </button>
                            )}
                        </header>

                        <div className="flex-1 overflow-y-auto p-6 bg-dots">
                            {showInsight ? (
                                <div className="fade-in bg-white p-6 rounded-2xl shadow-xl border border-purple-200">
                                    <h3 className="text-purple-600 font-extrabold text-2xl mb-4 flex items-center gap-2 font-brand">
                                        <Icons.Sparkles className="w-6 h-6"/> AI 洞察
                                    </h3>
                                    <div className="prose max-w-none text-stone-700 leading-loose text-sm" dangerouslySetInnerHTML={{ __html: marked.parse(insightResult || '生成中...') }} />
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 gap-3">
                                    {tasks.length === 0 ? (
                                        <div className="border-2 border-dashed border-stone-100 rounded-2xl p-10 text-center">
                                            <p className="text-stone-400 font-brand text-lg">暂无任务</p>
                                            <p className="text-stone-300 text-sm mt-2">AI 将根据您的日志自动提取待办事项。</p>
                                        </div>
                                    ) : tasks.map(task => (
                                        <div 
                                            key={task.id} 
                                            className={`group bg-white border border-stone-100 p-4 rounded-xl shadow-sm hover:shadow-md transition-all flex items-start gap-3 fade-in cursor-pointer ${task.done ? 'opacity-60 bg-stone-50' : 'hover:border-amber-300'}`}
                                            onClick={() => setSelectedTask(task)}
                                        >
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); toggleTask(task.id); }}
                                                className={`mt-1 w-5 h-5 rounded border flex items-center justify-center transition-colors ${task.done ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-stone-300 hover:border-emerald-400'}`}
                                            >
                                                {task.done && <Icons.CheckCircle className="w-3 h-3" />}
                                            </button>
                                            
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start">
                                                    <h3 className={`font-bold text-stone-800 ${task.done ? 'line-through text-stone-400' : ''}`}>{task.title}</h3>
                                                    <span className="text-[10px] font-mono text-stone-400 bg-stone-100 px-1.5 py-0.5 rounded">{task.time}m</span>
                                                </div>
                                                
                                                {task.desc && <p className="text-xs text-stone-500 mt-1">{task.desc}</p>}
                                                
                                                <div className="mt-3 flex justify-between items-center">
                                                    <span className={`text-[10px] font-bold uppercase px-2 py-0.5 rounded ${
                                                        task.category === 'design' ? 'bg-rose-50 text-rose-600' :
                                                        task.category === 'marketing' ? 'bg-orange-50 text-orange-600' :
                                                        task.category === 'admin' ? 'bg-slate-50 text-slate-600' :
                                                        task.category === 'finance' ? 'bg-green-50 text-green-600' :
                                                        'bg-blue-50 text-blue-600'
                                                    }`}>
                                                        {task.category || 'general'}
                                                    </span>
                                                    <div className="opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); deleteTask(task.id); }} 
                                                            className="text-stone-300 hover:text-red-400" 
                                                        >
                                                            <Icons.Trash2 className="w-4 h-4"/>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>