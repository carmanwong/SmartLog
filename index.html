<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello Milk Tee - Smart Log (2025 Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        .font-brand { font-family: 'Outfit', sans-serif; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bg-milk-base { background-color: #faf9f6; }
        .bg-milk-card { background-color: #ffffff; }
        .text-milk-dark { color: #5d4037; }
        .text-milk-brand { color: #d97706; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e8dcd1; border-radius: 10px; }
        .prose h1, .prose h2, .prose h3 { color: #5d4037; font-weight: 700; margin-top: 1em; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
    </style>
</head>
<body class="bg-milk-base text-stone-700 h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ⚠️ 核心修复：使用 2025 年最新的 gemini-2.5-flash 模型 ---
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";
        
        const Icons = {
            Coffee: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            Send: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Brain: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Sparkles: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/><path d="M3 5h4"/></svg>,
            Settings: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>,
            Download: ({className}) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Upload: ({className}) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            CheckCircle: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Trash2: ({className}) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            X: ({className}) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Layers: ({className}) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="m12.83 21.41-.66 1.15a.5.5 0 0 1-.84 0l-.66-1.15"/><path d="m16.5 17.5 5.5-10.5L12 2 2.5 7.5l5.5 10.5"/><path d="M2.5 7.5 12 13l9.5-5.5"/><path d="M12 2v11"/></svg>,
            Save: ({className}) => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        };

        async function cleanTextAI(apiKey, text) {
            const prompt = `Translate this to professional Chinese, fix grammar, keep it concise: "${text}"`;
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        }

        async function analyzeTasksAI(apiKey, logText) {
            const prompt = `Extract tasks from Chinese text: "${logText}". Return JSON array: [{ "title": "Chinese Title", "desc": "Brief Desc", "time": Number(minutes), "category": "admin|design|marketing|finance|ops" }]. If no tasks, return []. Output ONLY JSON.`;
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            try {
                const txt = data.candidates[0].content.parts[0].text;
                return JSON.parse(txt.replace(/```json|```/g, '').trim());
            } catch (e) { return []; }
        }
        
        async function decomposeTaskAI(apiKey, task) {
             const prompt = `Decompose task "${task.title}" (${task.desc}) into 3-5 steps in Chinese Markdown.`;
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        }

        async function generateInsightAI(apiKey, logs) {
            const recent = logs.slice(0, 30).map(l => l.text).join('\n');
            const prompt = `Analyze these work logs for a Design/Ops staff. Provide Summary, Bottlenecks, Focus in Chinese Markdown:\n${recent}`;
            const response = await fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        }

        const TaskDetailModal = ({ task, onClose, apiKey }) => {
            const [decomposition, setDecomposition] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const load = async () => {
                    try { setDecomposition(await decomposeTaskAI(apiKey, task)); } 
                    catch (e) { setDecomposition("无法生成: " + e.message); } 
                    finally { setIsLoading(false); }
                };
                load();
            }, [task]);

            return (
                <div className="modal-backdrop fade-in" onClick={onClose}>
                    <div className="bg-milk-card rounded-2xl p-6 w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4"><h2 className="font-bold text-xl">{task.title}</h2><button onClick={onClose}><Icons.X className="w-5 h-5"/></button></div>
                        {isLoading ? <div className="text-center py-10">AI 正在思考...</div> : <div className="prose text-sm" dangerouslySetInnerHTML={{ __html: marked.parse(decomposition || '') }} />}
                    </div>
                </div>
            );
        };

        function App() {
            const [logs, setLogs] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [showInsight, setShowInsight] = useState(false); 
            const [insightResult, setInsightResult] = useState('');
            const [selectedTask, setSelectedTask] = useState(null);
            const fileInputRef = useRef(null);
            const scrollRef = useRef(null);

            // ---------------------------------------------------------
            // ⚠️ 请在这里填入你的 Key，保留双引号
            // ---------------------------------------------------------
            const HARDCODED_KEY = "AIzaSyBwNmtX2VZZybQBoQorPqH75LvQID5B9H0"; 

            const aiKey = HARDCODED_KEY; 

            useEffect(() => {
                const saved = localStorage.getItem('milktea_local_data_v2');
                if (saved) { try { const p = JSON.parse(saved); setLogs(p.logs||[]); setTasks(p.tasks||[]); } catch(e){} }
            }, []);

            useEffect(() => {
                localStorage.setItem('milktea_local_data_v2', JSON.stringify({ logs, tasks }));
            }, [logs, tasks]);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputText.trim()) return;
                if (!aiKey || aiKey.includes("请在这里")) { alert("请先在代码中填入正确的 API Key！"); return; }
                
                const raw = inputText;
                setInputText('');
                setIsProcessing(true);
                setStatusMsg('AI 正在处理...');

                try {
                    let cleaned = raw;
                    try { cleaned = await cleanTextAI(aiKey, raw); } catch(e) { console.warn(e); }

                    const newLog = { id: Date.now().toString(), raw, text: cleaned, createdAt: new Date().toISOString() };
                    setLogs(p => [newLog, ...p]);

                    const newTasks = await analyzeTasksAI(aiKey, cleaned);
                    if (newTasks.length) {
                         setTasks(p => [...newTasks.map((t,i)=>({...t, id: Date.now()+'-'+i, done:false})), ...p]);
                         setStatusMsg(`提取了 ${newTasks.length} 个任务`);
                    } else {
                        setStatusMsg('已记录');
                    }
                } catch (e) {
                    setStatusMsg("错误: " + e.message);
                    setInputText(raw);
                } finally {
                    setIsProcessing(false);
                    setTimeout(() => setStatusMsg(''), 2000);
                }
            };

            const handleInsight = async () => {
                if(!logs.length) return;
                setShowInsight(true); setIsProcessing(true); setInsightResult('');
                try { setInsightResult(await generateInsightAI(aiKey, logs)); } catch(e) { setInsightResult(e.message); }
                setIsProcessing(false);
            };

            const toggleTask = (id) => setTasks(p => p.map(t => t.id === id ? { ...t, done: !t.done } : t));
            const deleteTask = (id) => { if(confirm("删除?")) setTasks(p => p.filter(t => t.id !== id)); };
            const handleExport = () => {
                const blob = new Blob([JSON.stringify({logs, tasks})], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "backup.json"; a.click();
            };
            const handleImport = (e) => {
                const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); setLogs(d.logs); setTasks(d.tasks); } catch(e){} };
                if(e.target.files[0]) r.readAsText(e.target.files[0]);
            };

            return (
                <div className="flex h-full max-w-6xl mx-auto w-full bg-white shadow-xl md:rounded-2xl md:my-4 overflow-hidden border border-stone-100">
                    <input type="file" ref={fileInputRef} onChange={handleImport} className="hidden" />
                    {selectedTask && <TaskDetailModal task={selectedTask} onClose={() => setSelectedTask(null)} apiKey={aiKey} />}

                    <div className="w-full md:w-5/12 bg-stone-50 border-r border-stone-100 flex flex-col">
                        <header className="p-4 border-b bg-white flex justify-between items-center">
                            <h1 className="font-brand font-bold text-xl text-milk-dark flex gap-2"><Icons.Brain className="w-6 h-6 text-purple-600"/> 日志流</h1>
                            <div className="flex gap-2">
                                <span className="text-xs text-stone-300 flex items-center"><Icons.Save className="w-3 h-3 mr-1"/>自动保存</span>
                                <button onClick={handleExport} className="text-stone-400 hover:text-stone-600"><Icons.Download className="w-5 h-5"/></button>
                                <button onClick={()=>fileInputRef.current.click()} className="text-stone-400 hover:text-stone-600"><Icons.Upload className="w-5 h-5"/></button>
                            </div>
                        </header>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>
                            {logs.map(log => (
                                <div key={log.id} className="pl-4 border-l-2 border-stone-200 fade-in relative">
                                    <div className="absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-stone-300"></div>
                                    <div className="text-[10px] text-stone-400 mb-1">{new Date(log.createdAt).toLocaleString('zh-CN', {month:'short', day:'numeric', hour:'numeric', minute:'numeric'})}</div>
                                    <div className="text-sm text-stone-800 whitespace-pre-wrap">{log.text}</div>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 bg-white border-t">
                            <div className="text-xs text-amber-600 h-4 mb-1 font-bold">{statusMsg}</div>
                            <form onSubmit={handleSubmit} className="relative">
                                <textarea value={inputText} onChange={e=>setInputText(e.target.value)} className="w-full bg-stone-50 border rounded-xl p-3 pr-10 text-sm outline-none focus:ring-2 focus:ring-amber-500 resize-none" rows="3" placeholder="输入..."></textarea>
                                <button disabled={isProcessing} type="submit" className="absolute right-2 bottom-2 p-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 disabled:opacity-50"><Icons.Send className="w-4 h-4"/></button>
                            </form>
                        </div>
                    </div>

                    <div className="hidden md:flex w-7/12 bg-white flex-col">
                        <header className="p-4 border-b flex justify-between items-center">
                            <h2 className="font-brand font-bold text-xl text-milk-brand flex gap-2"><Icons.Coffee className="w-6 h-6"/> {showInsight?'周报':'待办'}</h2>
                            <div className="flex gap-2">
                                {showInsight ? <button onClick={()=>setShowInsight(false)} className="text-sm bg-stone-100 px-3 py-1 rounded-full">返回</button> : 
                                <button onClick={handleInsight} className="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full flex gap-1 items-center"><Icons.Sparkles className="w-3 h-3"/> AI 周报</button>}
                            </div>
                        </header>
                        <div className="flex-1 overflow-y-auto p-6 bg-dots">
                            {showInsight ? <div className="prose text-sm" dangerouslySetInnerHTML={{__html: marked.parse(insightResult || '生成中...')}}/> : 
                            <div className="space-y-3">
                                {tasks.length===0 && <div className="text-center text-stone-300 py-10">任务列表为空</div>}
                                {tasks.map(t => (
                                    <div key={t.id} onClick={()=>setSelectedTask(t)} className={`p-4 border rounded-xl flex gap-3 cursor-pointer hover:shadow-md transition-all ${t.done?'opacity-50 bg-stone-50':'bg-white'}`}>
                                        <button onClick={(e)=>{e.stopPropagation();toggleTask(t.id)}} className={`w-5 h-5 rounded border flex items-center justify-center ${t.done?'bg-emerald-500 text-white':''}`}>{t.done && <Icons.CheckCircle className="w-3 h-3"/>}</button>
                                        <div className="flex-1">
                                            <div className="flex justify-between"><span className={t.done?'line-through':''}>{t.title}</span><span className="text-xs text-stone-400 bg-stone-100 px-1 rounded">{t.time}m</span></div>
                                            <div className="flex justify-between mt-2"><span className="text-[10px] uppercase font-bold text-stone-400">{t.category}</span><button onClick={(e)=>{e.stopPropagation();deleteTask(t.id)}} className="text-stone-300 hover:text-red-400"><Icons.Trash2 className="w-4 h-4"/></button></div>
                                        </div>
                                    </div>
                                ))}
                            </div>}
                        </div>
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>